<template>
  <q-page class="q-pa-md problem-explanation-page">
    <div class="row justify-center">
      <div class="col-12 col-md-7">
        <q-card flat class="bg-grey-1 text-dark q-px-sm q-pb-sm">
          <!-- í—¤ë” (ë¬¸ì œ ì œëª©, ë‚œì´ë„, etc.) -->
          <q-card-section>
            <div class="text-h5">{{ problemTitle }}</div>
            <div class="text-caption text-grey">ì‚¬ìš© ëŒ€ìƒ: í•™ìŠµì</div>
            <q-badge
              v-if="difficulty"
              :label="difficultyLabel"
              :color="difficultyColor"
              class="q-mt-sm"
            />
          </q-card-section>

          <!-- ë¬¸ì œ ëª©í‘œ / ì‹œë‚˜ë¦¬ì˜¤ ì„¤ëª… -->
          <q-separator spaced />
          <q-card-section>
            <div class="text-h5">1ï¸âƒ£ì‹¤ìŠµ ëª©í‘œğŸ¯</div>
            <div class="text-h6">
              <ul class="q-mt-none">
                <li>íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ì„ ì•…ìš©í•œ RCE(Remote Code Execution) ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹¤ìŠµí•©ë‹ˆë‹¤.</li>
                <li>ê²€ì¦ë˜ì§€ ì•Šì€ íŒŒì¼ ì—…ë¡œë“œì™€ ì‹¤í–‰ ê²½ë¡œ ë…¸ì¶œì˜ ìœ„í—˜ì„±ì„ ì´í•´í•©ë‹ˆë‹¤.</li>
                <li>
                  ì•…ì„± PHP ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì—…ë¡œë“œí•˜ì—¬ ì„œë²„ ë‚´ë¶€ FLAG íŒŒì¼ì„ ì½ê³ , ì´ë¥¼ ë¸Œë¼ìš°ì €ì—ì„œ
                  ì¶œë ¥ë˜ë„ë¡ ë§Œë“­ë‹ˆë‹¤.
                </li>
              </ul>
            </div>
            <div class="text-h5 q-mt-md">2ï¸âƒ£ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤ğŸ­</div>
            <div class="text-h6 q-pl-md">
              <div>{{ problemScenario }}</div>
              <div>
                ë°±ì—”ë“œ <span style="color: red">/upload</span> APIëŠ” ì—…ë¡œë“œëœ íŒŒì¼ì„ í”„ë¡ íŠ¸ì—”ë“œ
                ì„œë²„ì˜ <span style="color: red">/uploads/</span> ê²½ë¡œì— ì €ì¥í•©ë‹ˆë‹¤. ì´ ê²½ë¡œëŠ” ì›¹ì—
                ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë©°, ì‹¤í–‰ ê¶Œí•œë„ ë¶€ì—¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì„œë²„ ë‚´
                <span style="color: red">/flag.txt</span> íŒŒì¼ì„ ì½ëŠ” PHP ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë§Œë“¤ì–´
                ì—…ë¡œë“œí•˜ê³ , ì‹¤í–‰í•˜ì—¬ FLAGë¥¼ íšë“í•˜ì„¸ìš”.
              </div>
            </div>
          </q-card-section>

          <!-- ë¬¸ì œ ë‚œì´ë„ í‘œì‹œ -->
          <q-separator spaced />
          <q-card-section>
            <div class="row items-center">
              <div class="col-4 text-bold">ë¬¸ì œ ë‚œì´ë„</div>
              <div class="col">
                <span>{{ difficultyLabel }}</span>
              </div>
            </div>
          </q-card-section>

          <!-- íŒíŠ¸ ì„¹ì…˜ (í† ê¸€) -->
          <q-separator spaced />
          <q-expansion-item group="hint" icon="help_outline" label="íŒíŠ¸" expand-separator>
            <div class="q-pl-md text-body1">
              <div style="display: list-item; list-style-type: disc">
                <span style="color: red">.php</span> í™•ì¥ìë¥¼ ì‚¬ìš©í•´ì•¼ Apacheê°€ ì½”ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
              </div>
              <div style="display: list-item; list-style-type: disc">
                <span style="color: red">system()</span> í•¨ìˆ˜ ì™¸ì—ë„
                <span style="color: red">exec()</span> ë‹¤ì–‘í•œ ëª…ë ¹ ì‹¤í–‰ í•¨ìˆ˜ ì‚¬ìš© ê°€ëŠ¥
              </div>
              <div style="display: list-item; list-style-type: disc">
                ì—…ë¡œë“œ í›„ URLì´ ì˜ëª»ë˜ë©´ ì‹¤í–‰ì´ ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì •í™•í•œ ê²½ë¡œ(
                <span style="color: red">uploads/íŒŒì¼ëª….php</span> )ë¥¼ í™•ì¸í•˜ì„¸ìš”.
              </div>
              <div style="display: list-item; list-style-type: disc">
                ë³´ì•ˆìƒ ì‹¤ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì ˆëŒ€ í—ˆìš©ë˜ì–´ì„  ì•ˆ ë˜ëŠ” ì·¨ì•½ êµ¬ì¡°ì…ë‹ˆë‹¤.
              </div>
            </div>
          </q-expansion-item>

          <!-- ì •ë‹µ ì…ë ¥ / ê²°ê³¼ í™•ì¸ -->
          <q-separator spaced />
          <q-card-section>
            <h6>ë¬¸ì œ í•´ê²°(ì •ë‹µ) ì…ë ¥</h6>
            <q-input v-model="userAnswer" filled placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" class="q-my-sm" />
            <div class="colunm q-gutter-x-sm">
              <q-btn label="ì œì¶œ" color="black" @click="onSubmitAnswer" />
              <q-btn
                label="í•´ì„¤"
                color="black"
                :to="{ name: 'WargameExplanationCmdInjection' }"
              ></q-btn>
            </div>
            <!--
  <div v-if="submitResult" class="q-mt-sm">
    <q-banner
      v-if="submitSuccess"
      type="positive"
      icon="check_circle"
      :label="successMessage"
    />
    <q-banner v-else type="negative" icon="warning" :label="failMessage" />
  </div>
  -->
            <div v-if="submitResult" class="q-mt-sm">
              <div v-if="submitSuccess" style="color: green">{{ successMessage }}</div>
              <div v-else style="color: red">{{ failMessage }}</div>
            </div>
          </q-card-section>
          <q-separator spaced />
          <q-card-section>
            <div class="text-h6">ë¬¸ì œ ê´€ë ¨ ì•¡ì…˜</div>
            <p class="text-body2 text-grey q-mt-sm">
              ì‹¤ìŠµ í™˜ê²½ì„ ìƒì„±í•˜ê³ , ë¬¸ì œë¥¼ ì§ì ‘ í’€ì–´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
          </q-card-section>
          <q-card-section>
            <q-btn
              label="ì„œë²„ ìƒì„±"
              color="accent"
              icon="build"
              class="full-width q-my-sm"
              @click="onCreateServer"
            />
            <div v-if="serverCreated" class="text-positive q-my-sm">
              ì„œë²„ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ì‹¤ìŠµ í™˜ê²½ìœ¼ë¡œ ì´ë™í•´ ë³´ì„¸ìš”.
            </div>
            <q-btn
              label="ì‹¤ìŠµ ì‹œì‘"
              color="primary"
              icon="play_arrow"
              class="full-width q-my-sm"
              @click="onStartPractice"
            />
          </q-card-section>
        </q-card>
      </div>
    </div>
  </q-page>
</template>

<script setup>
import { ref, computed } from 'vue'
import { api } from 'src/boot/axios'
import { useAuthStore } from 'src/stores/auth'

// ë¬¸ì œ ì •ë³´
const problemTitle = ref('ì•…ì„± PHP ìŠ¤í¬ë¦½íŠ¸ë¥¼ í†µí•œ FLAG íšë“')
const problemScenario = ref('ğŸ’¡ ë‹¹ì‹ ì€ ì—…ë¡œë“œ ê¸°ëŠ¥ì´ ìˆëŠ” ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì¼ë°˜ ì‚¬ìš©ìì…ë‹ˆë‹¤.')
const difficulty = ref('hard')

const auth = useAuthStore()

const difficultyLabel = computed(() => {
  if (difficulty.value === 'easy') return 'ì´ˆê¸‰'
  if (difficulty.value === 'hard') return 'ê³ ê¸‰'
  return 'ì¤‘ê¸‰'
})
const difficultyColor = computed(() => {
  if (difficulty.value === 'easy') return 'green'
  if (difficulty.value === 'hard') return 'red'
  return 'orange'
})

// ì •ë‹µ ì œì¶œ
const userAnswer = ref('')
const submitResult = ref(false)
const submitSuccess = ref(false)
const successMessage = ref('ì„±ê³µ! ë¬¸ì œë¥¼ í•´ê²°í•˜ì…¨ìŠµë‹ˆë‹¤.')
const failMessage = ref('ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ ë³´ì„¸ìš”.')

async function onSubmitAnswer() {
  const email = auth.user?.email
  const labId = 10 // ë¬¸ì œë§ˆë‹¤ ê³ ìœ  lab_id ë¶€ì—¬(ì´ ë¬¸ì œ ì˜ˆ: 10)

  // ì •ë‹µ ë¹„êµ (ì˜ˆ: '1234'ê°€ ì •ë‹µ)
  const correct = userAnswer.value.trim() === '0a1b2c3d4e5f60718293a4b5c6d7e8f9'
  const status = correct ? 'completed' : 'in-progress'

  try {
    const res = await api.post('/labs/labs/submit', {
      email: email,
      lab_id: labId,
      is_correct: correct,
      status: status,
    })
    console.log('ì„œë²„ ì‘ë‹µ:', res.data)

    successMessage.value = 'ì„±ê³µ! ë¬¸ì œë¥¼ í•´ê²°í•˜ì…¨ìŠµë‹ˆë‹¤.'
    failMessage.value = 'ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ ë³´ì„¸ìš”.'
    // if (res.data && res.data.status) {
    //   successMessage.value = correct ? `ì„±ê³µ! ì„œë²„ ì‘ë‹µ: ${res.data.status}` : successMessage.value
    //   failMessage.value = !correct ? `ì‹¤íŒ¨! ì„œë²„ ì‘ë‹µ: ${res.data.status}` : failMessage.value
    // }
    submitSuccess.value = correct
    submitResult.value = true
  } catch (e) {
    submitSuccess.value = false
    submitResult.value = true
    failMessage.value = 'ì„œë²„ ì˜¤ë¥˜! ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'
    console.error(e)
  }
}

// ì„œë²„ ìƒì„±
const serverCreated = ref(false)
const frontendPort = ref(null)
const frontendHost = '100.108.98.2' // ì‹¤ìŠµí™˜ê²½ ë„ì»¤ ì»¨í…Œì´ë„ˆ host (ê³ ì •)
async function onCreateServer() {
  const email = auth.user?.email
  const lab_id = 10
  if (!email) {
    alert('ë¡œê·¸ì¸ ë¨¼ì € í•´ì£¼ì„¸ìš”!')
    return
  }
  try {
    // ë¬¸ì œ id ê³ ì •(10)
    await api.post('/labs/labs/environment', {
      email: email,
      lab_id: lab_id,
    })
    const res = await api.post('/containers/start', { problem_id: lab_id })
    frontendPort.value = res.data.frontend_port
    serverCreated.value = true
  } catch (err) {
    serverCreated.value = false
    frontendPort.value = null
    alert('ì„œë²„ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
    console.error(err)
  }
}

// ì‹¤ìŠµ ì‹œì‘
function onStartPractice() {
  if (serverCreated.value && frontendPort.value) {
    window.open(`http://${frontendHost}:${frontendPort.value}`, '_blank')
  } else {
    alert('ë¨¼ì € ì„œë²„ë¥¼ ìƒì„±í•˜ì„¸ìš”!')
  }
}
</script>

<style scoped>
.problem-explanation-page {
  background-color: #f5f5f5;
  min-height: 100vh; /* í˜ì´ì§€ ì „ì²´ ë†’ì´ ì°¨ì§€ */
}
.q-card {
  border-radius: 8px;
}
.full-width {
  width: 100%;
}
</style>
